<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>자리 배정</title>
  <style>
    body {
      font-size: 16px;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }

    @media (max-width: 768px) {
      body {
        font-size: 20px;
      }
      button, input {
        font-size: 18px;
        padding: 12px;
      }
    }

    #board {
      display: grid;
      gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }

    .cell {
      width: 50px;
      height: 50px;
      border: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .cell:hover {
      background: #e8f6ff;
    }

    .disabled {
      background: #bbb;
      cursor: not-allowed;
    }

    .fixed {
      background: #ffeaa7 !important;
      font-weight: bold;
    }

    .blackboard {
      width: 200px;
      height: 50px;
      background: green;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px auto;
      border-radius: 8px;
    }

    input {
      width: 60px;
      padding: 5px;
      margin: 0 5px;
    }

    button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .create-btn {
      background-color: #3498db;
      color: white;
    }

    .random-btn {
      background-color: #2ecc71;
      color: white;
    }
  </style>
</head>
<body>
  <h2>자리 배정 보드</h2>

  <div>
    <label>행: <input type="number" id="rows" value="5" min="1"></label>
    <label>열: <input type="number" id="cols" value="6" min="1"></label>
  </div>

  <div style="margin-top: 8px;">
    <label>사용하지 않는 좌석: <input type="number" id="disabledSeats" value="0" min="0"></label>
    <button class="create-btn" onclick="generateBoard()">보드 생성</button>
  </div>

  <div class="blackboard">칠판</div>

  <div id="board"></div>

  <button class="random-btn" onclick="randomizeBoard()" style="display:none;" id="randomBtn">
    랜덤 돌리기
  </button>
  
  <div id="counterBox" style="display:none; margin-top:10px; font-size:16px; font-weight:bold; color:#333;">
    돌린 횟수: 0
  </div>

  <script>
    let rows = 0, cols = 0, disabledSeats = 0, count = 0;
    let manualAssignments = {};

    function generateBoard() {
      rows = parseInt(document.getElementById("rows").value);
      cols = parseInt(document.getElementById("cols").value);
      disabledSeats = parseInt(document.getElementById("disabledSeats").value);

      const board = document.getElementById("board");
      board.innerHTML = "";
      board.style.gridTemplateColumns = `repeat(${cols}, 50px)`;

      const totalSeats = rows * cols;
      for (let i = 0; i < totalSeats; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.index = i;
        cell.addEventListener("click", () => handleCellClick(i));
        board.appendChild(cell);
      }

      const cells = document.querySelectorAll(".cell");
      for (let i = 0; i < disabledSeats; i++) {
        const index = totalSeats - 1 - i;
        cells[index].classList.add("disabled");
      }

      manualAssignments = {};
      count = 0;
      document.getElementById("counterBox").style.display = "block";
      document.getElementById("counterBox").textContent = "돌린 횟수: 0";
      document.getElementById("randomBtn").style.display = "inline-block";
    }

    function handleCellClick(index) {
      const cell = document.querySelectorAll(".cell")[index];
      if (cell.classList.contains("disabled")) return;

      if (manualAssignments[index] !== undefined) {
        delete manualAssignments[index];
        cell.textContent = "";
        cell.classList.remove("fixed");
      } else {
        const num = prompt("이 자리에 넣을 번호를 입력하세요:");
        if (!num) return;
        const number = parseInt(num);
        if (isNaN(number)) return alert("숫자를 입력하세요!");

        const exists = Object.values(manualAssignments).includes(number);
        if (exists) return alert(`${number}번은 이미 지정된 자리입니다.`);

        manualAssignments[index] = number;
        cell.textContent = number;
        cell.classList.add("fixed");
      }
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function randomizeBoard() {
      const board = document.getElementById("board");
      const cells = board.querySelectorAll(".cell");
      const totalSeats = rows * cols;
      const activeSeats = totalSeats - disabledSeats;

      count++;
      document.getElementById("counterBox").textContent = `돌린 횟수: ${count}`;

      const fixedIndexes = Object.keys(manualAssignments).map(Number);
      const fixedNumbers = Object.values(manualAssignments);

      let availableNumbers = Array.from({ length: activeSeats }, (_, i) => i + 1)
        .filter(n => !fixedNumbers.includes(n));

      // --- 3의 배수일 때: 완전 랜덤 배치 (수동 지정 제외) ---
      if (count % 3 === 0) {
        const randomNumbers = shuffle([...availableNumbers]);
        let idx = 0;
        for (let i = 0; i < totalSeats; i++) {
          const cell = cells[i];
          if (cell.classList.contains("disabled")) {
            cell.textContent = "";
            continue;
          }
          if (fixedIndexes.includes(i)) {
            cell.textContent = manualAssignments[i];
            cell.classList.add("fixed");
            continue;
          }
          cell.textContent = randomNumbers[idx++];
          cell.classList.remove("fixed");
        }
        return;
      }

      // === 일반 규칙 적용 모드 ===
      // 22번 자리 후보 (맨 아래줄 + 아래쪽 절반의 양쪽 끝)
      const bottomIndexes = [];
      for (let c = 0; c < cols; c++) bottomIndexes.push((rows - 1) * cols + c);
      const sideIndexes = [];
      for (let r = Math.floor(rows / 2); r < rows; r++) {
        sideIndexes.push(r * cols);
        sideIndexes.push(r * cols + (cols - 1));
      }
      const valid22Spots = [...bottomIndexes, ...sideIndexes];
      const available22 = valid22Spots.filter(i => !fixedIndexes.includes(i));
      const idx22 = available22[Math.floor(Math.random() * available22.length)];

      // 3번 자리 후보 (22번 기준 인접 위쪽·양옆·대각선)
      const row22 = Math.floor(idx22 / cols);
      const col22 = idx22 % cols;
      const candidate3 = [];
      for (let dr = -2; dr <= 0; dr++) {
        for (let dc = -2; dc <= 2; dc++) {
          const r = row22 + dr;
          const c = col22 + dc;
          if (r >= 0 && r < rows && c >= 0 && c < cols) {
            if (!(r === row22 && c === col22)) candidate3.push(r * cols + c);
          }
        }
      }
      const available3 = candidate3.filter(i => !fixedIndexes.includes(i) && i !== idx22);
      const idx3 = available3[Math.floor(Math.random() * available3.length)];

      // 나머지 번호 섞기
      availableNumbers = availableNumbers.filter(n => ![3, 22].includes(n));
      const shuffled = shuffle(availableNumbers);
      let idx = 0;

      for (let i = 0; i < totalSeats; i++) {
        const cell = cells[i];
        if (cell.classList.contains("disabled")) {
          cell.textContent = "";
          continue;
        }
        if (fixedIndexes.includes(i)) {
          cell.textContent = manualAssignments[i];
          cell.classList.add("fixed");
          continue;
        }
        if (i === idx22) {
          cell.textContent = 22;
          cell.classList.remove("fixed");
          continue;
        }
        if (i === idx3) {
          cell.textContent = 3;
          cell.classList.remove("fixed");
          continue;
        }
        cell.textContent = shuffled[idx++];
        cell.classList.remove("fixed");
      }
    }
  </script>
</body>
</html>